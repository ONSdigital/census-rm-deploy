resource_types:

  - name: github-release-latest
    type: docker-image
    source:
      repository: concourse/github-release-resource
      tag: 1.1.0

resources:

  - name: acceptance-tests-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-acceptance-tests
      access_token: ((github.access_token))
      order_by: time

  - name: action-scheduler-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-action-scheduler
      access_token: ((github.access_token))
      order_by: time

  - name: case-api-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-case-api
      access_token: ((github.access_token))
      order_by: time

  - name: case-processor-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-case-processor
      access_token: ((github.access_token))
      order_by: time

  - name: print-file-service-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-print-file-service
      access_token: ((github.access_token))
      order_by: time

  - name: uac-qid-service-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-uac-qid-service
      access_token: ((github.access_token))
      order_by: time

  - name: ops-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-ops
      access_token: ((github.access_token))
      order_by: time

  - name: pubsub-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-pubsub
      access_token: ((github.access_token))
      order_by: time

  - name: qid-batch-runner-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-qid-batch-runner
      access_token: ((github.access_token))
      order_by: time

  - name: sample-loader-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-sample-loader
      access_token: ((github.access_token))
      order_by: time

  - name: fieldwork-adapter-release
    type: github-release-latest
    source:
      owner: ONSdigital
      repository: census-rm-fieldwork-adapter
      access_token: ((github.access_token))
      order_by: time

  - name: acceptance-tests-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-acceptance-tests
      username: _json_key
      password: ((gcp.service_account_json))

  - name: acceptance-tests-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-acceptance-tests
      username: _json_key
      password: ((gcp.service_account_json))

  - name: action-scheduler-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-action-scheduler
      username: _json_key
      password: ((gcp.service_account_json))

  - name: action-scheduler-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-action-scheduler
      username: _json_key
      password: ((gcp.service_account_json))

  - name: case-api-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-case-api
      username: _json_key
      password: ((gcp.service_account_json))

  - name: case-api-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-case-api
      username: _json_key
      password: ((gcp.service_account_json))

  - name: case-processor-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-case-processor
      username: _json_key
      password: ((gcp.service_account_json))
  
  - name: case-processor-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-case-processor
      username: _json_key
      password: ((gcp.service_account_json))

  - name: print-file-service-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-print-file-service
      username: _json_key
      password: ((gcp.service_account_json))

  - name: print-file-service-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-print-file-service
      username: _json_key
      password: ((gcp.service_account_json))

  - name: uac-qid-service-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-uac-qid-service
      username: _json_key
      password: ((gcp.service_account_json))

  - name: uac-qid-service-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-uac-qid-service
      username: _json_key
      password: ((gcp.service_account_json))

  - name: ops-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-ops
      username: _json_key
      password: ((gcp.service_account_json))

  - name: ops-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-ops
      username: _json_key
      password: ((gcp.service_account_json))

  - name: pubsub-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-pubsub
      username: _json_key
      password: ((gcp.service_account_json))

  - name: pubsub-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-pubsub
      username: _json_key
      password: ((gcp.service_account_json))

  - name: qid-batch-runner-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-qid-batch-runner
      username: _json_key
      password: ((gcp.service_account_json))

  - name: qid-batch-runner-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-qid-batch-runner
      username: _json_key
      password: ((gcp.service_account_json))

  - name: sample-loader-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-sample-loader
      username: _json_key
      password: ((gcp.service_account_json))

  - name: sample-loader-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-sample-loader
      username: _json_key
      password: ((gcp.service_account_json))

  - name: fieldwork-adapter-docker-image-ci
    type: docker-image
    source:
      repository: ((docker-registry-ci))/rm/census-rm-fieldwork-adapter
      username: _json_key
      password: ((gcp.service_account_json))
  
  - name: fieldwork-adapter-docker-image-gcr
    type: docker-image
    source:
      repository: ((docker-registry-gcr))/rm/census-rm-fieldwork-adapter
      username: _json_key
      password: ((gcp.service_account_json))


jobs:

  - name: build-action-scheduler-release
    plan:
    - get: action-scheduler-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Action Scheduler Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: adoptopenjdk/maven-openjdk11
        inputs:
          - name: action-scheduler-release
        outputs:
          - name: build
          - name: extracted-action-scheduler
        run:
          path: sh
          args:
            - -exc
            - |
              mkdir -p build/target
              cd action-scheduler-release
              tar -xzf source.tar.gz -C ../extracted-action-scheduler --strip-components=1
              cd ../extracted-action-scheduler
              mvn package -DskipITs -Ddockerfile.skip
              cp target/census-rm-*.jar ../build/target
              cp Dockerfile ../build
              cp healthcheck.sh ../build
    - put: action-scheduler-docker-image-ci
      params:
        build: build
        tag_file: action-scheduler-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: action-scheduler-docker-image-gcr
      params:
        build: build
        cache_from:
          - action-scheduler-docker-image-ci
        tag_file: action-scheduler-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-case-api-release
    plan:
    - get: case-api-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Case API Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: adoptopenjdk/maven-openjdk11
        inputs:
          - name: case-api-release
        outputs:
          - name: build
          - name: extracted-case-api
        run:
          path: sh
          args:
            - -exc
            - |
              mkdir -p build/target
              cd case-api-release
              tar -xzf source.tar.gz -C ../extracted-case-api --strip-components=1
              cd ../extracted-case-api
              mvn package -DskipITs -Ddockerfile.skip
              cp target/census-rm-*.jar ../build/target
              cp Dockerfile ../build
    - put: case-api-docker-image-ci
      params:
        build: build
        tag_file: case-api-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: case-api-docker-image-gcr
      params:
        build: build
        cache_from:
          - case-api-docker-image-ci
        tag_file: case-api-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-case-processor-release
    plan:
    - get: case-processor-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Case Processor Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: adoptopenjdk/maven-openjdk11
        inputs:
          - name: case-processor-release
        outputs:
          - name: build
          - name: extracted-case-processor
        run:
          path: sh
          args:
            - -exc
            - |
              mkdir -p build/target
              cd case-processor-release
              tar -xzf source.tar.gz -C ../extracted-case-processor --strip-components=1
              cd ../extracted-case-processor
              mvn package -DskipITs -Ddockerfile.skip
              cp target/census-rm-*.jar ../build/target
              cp Dockerfile ../build
              cp healthcheck.sh ../build
    - put: case-processor-docker-image-ci
      params:
        build: build
        tag_file: case-processor-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: case-processor-docker-image-gcr
      params:
        build: build
        cache_from:
          - case-processor-docker-image-ci
        tag_file: case-processor-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-print-file-service-release
    plan:
    - get: print-file-service-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Print File Service Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: print-file-service-release
        outputs:
          - name: extracted-print-file-service
        run:
          path: sh
          args:
            - -exc
            - |
              cd print-file-service-release
              tar -xzf source.tar.gz -C ../extracted-print-file-service --strip-components=1
    - put: print-file-service-docker-image-ci
      params:
        build: extracted-print-file-service
        tag_file: print-file-service-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: print-file-service-docker-image-gcr
      params:
        build: extracted-print-file-service
        cache_from:
          - print-file-service-docker-image-ci
        tag_file: print-file-service-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-uac-qid-service-release
    plan:
    - get: uac-qid-service-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build UAC QID Service Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: adoptopenjdk/maven-openjdk11
        inputs:
          - name: uac-qid-service-release
        outputs:
          - name: build
          - name: extracted-uac-qid-service
        run:
          path: sh
          args:
            - -exc
            - |
              mkdir -p build/target
              cd uac-qid-service-release
              tar -xzf source.tar.gz -C ../extracted-uac-qid-service --strip-components=1
              cd ../extracted-uac-qid-service
              mvn package -DskipITs -Ddockerfile.skip
              cp target/census-rm-*.jar ../build/target
              cp Dockerfile ../build
    - put: uac-qid-service-docker-image-ci
      params:
        build: build
        tag_file: uac-qid-service-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: uac-qid-service-docker-image-gcr
      params:
        build: build
        cache_from:
          - uac-qid-service-docker-image-ci
        tag_file: uac-qid-service-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-ops-release
    plan:
    - get: ops-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Ops Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: ops-release
        outputs:
          - name: extracted-ops
        run:
          path: sh
          args:
            - -exc
            - |
              cd ops-release
              tar -xzf source.tar.gz -C ../extracted-ops --strip-components=1
    - put: ops-docker-image-ci
      params:
        build: extracted-ops
        tag_file: ops-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: ops-docker-image-gcr
      params:
        build: extracted-ops
        cache_from:
          - ops-docker-image-ci
        tag_file: ops-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-pubsub-release
    plan:
    - get: pubsub-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build PubSub Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: pubsub-release
        outputs:
          - name: extracted-pubsub
        run:
          path: sh
          args:
            - -exc
            - |
              cd pubsub-release
              tar -xzf source.tar.gz -C ../extracted-pubsub --strip-components=1
    - put: pubsub-docker-image-ci
      params:
        build: extracted-pubsub
        tag_file: pubsub-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: pubsub-docker-image-gcr
      params:
        build: extracted-pubsub
        cache_from:
          - pubsub-docker-image-ci
        tag_file: pubsub-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-batch-runner-release
    plan:
    - get: qid-batch-runner-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Batch Runner Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: qid-batch-runner-release
        outputs:
          - name: extracted-batch-runner
        run:
          path: sh
          args:
            - -exc
            - |
              cd qid-batch-runner-release
              tar -xzf source.tar.gz -C ../extracted-batch-runner --strip-components=1
    - put: qid-batch-runner-docker-image-ci
      params:
        build: extracted-batch-runner
        tag_file: qid-batch-runner-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: qid-batch-runner-docker-image-gcr
      params:
        build: extracted-batch-runner
        cache_from:
          - qid-batch-runner-docker-image-ci
        tag_file: qid-batch-runner-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-sample-loader-release
    plan:
    - get: sample-loader-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Sample Loader Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: sample-loader-release
        outputs:
          - name: extracted-sample-loader
        run:
          path: sh
          args:
            - -exc
            - |
              cd sample-loader-release
              tar -xzf source.tar.gz -C ../extracted-sample-loader --strip-components=1
    - put: sample-loader-docker-image-ci
      params:
        build: extracted-sample-loader
        tag_file: sample-loader-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: sample-loader-docker-image-gcr
      params:
        build: extracted-sample-loader
        cache_from:
          - sample-loader-docker-image-ci
        tag_file: sample-loader-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-fieldwork-adapter-release
    plan:
    - get: fieldwork-adapter-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Fieldwork Adapter Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: adoptopenjdk/maven-openjdk11
        inputs:
          - name: fieldwork-adapter-release
        outputs:
          - name: build
          - name: extracted-fieldwork-adapter
        run:
          path: sh
          args:
            - -exc
            - |
              mkdir -p build/target
              cd fieldwork-adapter-release
              tar -xzf source.tar.gz -C ../extracted-fieldwork-adapter --strip-components=1
              cd ../extracted-fieldwork-adapter
              mvn package -DskipITs -Ddockerfile.skip
              cp target/census-rm-*.jar ../build/target
              cp Dockerfile ../build
    - put: fieldwork-adapter-docker-image-ci
      params:
        build: build
        tag_file: fieldwork-adapter-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: fieldwork-adapter-docker-image-gcr
      params:
        build: build
        cache_from:
          - fieldwork-adapter-docker-image-ci
        tag_file: fieldwork-adapter-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true

  - name: build-acceptance-tests-release
    plan:
    - get: acceptance-tests-release
      params:
        include_source_tarball: true
      trigger: true
    - task: Build Acceptance Tests Image (release)
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        inputs:
          - name: acceptance-tests-release
        outputs:
          - name: extracted-acceptance-tests
        run:
          path: sh
          args:
            - -exc
            - |
              cd acceptance-tests-release
              tar -xzf source.tar.gz -C ../extracted-acceptance-tests --strip-components=1
    - put: acceptance-tests-docker-image-ci
      params:
        build: extracted-acceptance-tests
        tag_file: acceptance-tests-release/tag
        tag_as_latest: false
      get_params:
        save: true
    - put: acceptance-tests-docker-image-gcr
      params:
        build: extracted-acceptance-tests
        cache_from:
          - acceptance-tests-docker-image-ci
        tag_file: acceptance-tests-release/tag
        tag_as_latest: false
      get_params:
        skip_download: true